<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP8266 Control Panel</title>
  <script type="module">
    // Firebase Modular CDN imports (v10.12.5)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA8F8EODsT2p26ofkxHQCAA2emUxUKpA9A",
      databaseURL: "https://special-a6146-default-rtdb.firebaseio.com/",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Function to load all devices
    async function loadDevices() {
      const devicesRef = ref(db, '/devices');
      try {
        const snapshot = await get(devicesRef);
        const devices = snapshot.val() || {};
        const devicesContainer = document.getElementById('devices-container');
        devicesContainer.innerHTML = ''; // Clear previous content

        for (const macAddress in devices) {
          const device = devices[macAddress];
          const deviceDiv = document.createElement('div');
          deviceDiv.className = 'bg-white p-4 rounded-lg shadow mb-4';
          deviceDiv.innerHTML = `
            <h2 class="text-xl font-semibold mb-3 section-title">Device: ${macAddress}</h2>
            <div class="data-field"><span class="data-label">GPS Data</span></div>
            <div class="data-field"><span class="data-label">Latitude:</span> <span id="gps-latitude-${macAddress}" class="data-value">N/A</span></div>
            <div class="data-field"><span class="data-label">Longitude:</span> <span id="gps-longitude-${macAddress}" class="data-value">N/A</span></div>
            <div class="data-field"><span class="data-label">Button Data</span></div>
            <div class="data-field"><span class="data-label">State:</span> <span id="button-state-${macAddress}" class="data-value">Not Pressed</span></div>
            <div class="data-field"><span class="data-label">Press Latitude:</span> <span id="button-latitude-${macAddress}" class="data-value">N/A</span></div>
            <div class="data-field"><span class="data-label">Press Longitude:</span> <span id="button-longitude-${macAddress}" class="data-value">N/A</span></div>
            <div class="data-field"><span class="data-label">Date/Time:</span> <span id="button-datetime-${macAddress}" class="data-value">N/A</span></div>
            <div class="data-field"><span class="data-label">RFID Data</span></div>
            <div class="data-field"><span class="data-label">UID:</span> <strong id="rfid-uid-${macAddress}" class="data-value">none scanned</strong></div>
            <div class="mt-4 flex space-x-2">
              <button
                onclick="sendBuzzerCommand('${macAddress}', 'true')"
                class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"
              >
                True (Success)
              </button>
              <button
                onclick="sendBuzzerCommand('${macAddress}', 'false')"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
              >
                False (Alert)
              </button>
              <button
                onclick="sendBuzzerCommand('${macAddress}', 'error')"
                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"
              >
                Error (Warning)
              </button>
            </div>
          `;
          devicesContainer.appendChild(deviceDiv);

          // Update data for this device
          updateDeviceData(macAddress);
        }
      } catch (error) {
        console.error('Error loading devices:', error);
        document.getElementById('error-message').textContent = 'Error loading devices: ' + error.message;
      }
    }

    // Function to update data for a specific device
    function updateDeviceData(macAddress) {
      // GPS Data
      const gpsRef = ref(db, `/devices/${macAddress}/gps`);
      onValue(gpsRef, (snapshot) => {
        const data = snapshot.val() || {};
        document.getElementById(`gps-latitude-${macAddress}`).textContent = data.latitude ? data.latitude.toFixed(6) : 'N/A';
        document.getElementById(`gps-longitude-${macAddress}`).textContent = data.longitude ? data.longitude.toFixed(6) : 'N/A';
        console.log(`GPS data for ${macAddress}:`, data);
      }, (error) => {
        console.error(`GPS error for ${macAddress}:`, error);
        document.getElementById('error-message').textContent = `Error fetching GPS data for ${macAddress}: ${error.message}`;
      });

      // Button Data
      const buttonRef = ref(db, `/devices/${macAddress}/button`);
      onValue(buttonRef, (snapshot) => {
        const data = snapshot.val() || {};
        const wasPressed = document.getElementById(`button-state-${macAddress}`).textContent === 'Pressed';
        document.getElementById(`button-state-${macAddress}`).textContent = data.state ? 'Pressed' : 'Not Pressed';
        document.getElementById(`button-latitude-${macAddress}`).textContent = data.press_latitude ? data.press_latitude.toFixed(6) : 'N/A';
        document.getElementById(`button-longitude-${macAddress}`).textContent = data.press_longitude ? data.press_longitude.toFixed(6) : 'N/A';
        document.getElementById(`button-datetime-${macAddress}`).textContent = data.datetime || 'N/A';
        
        // Show notification if button is pressed
        if (data.state && !wasPressed) {
          const notification = document.createElement('div');
          notification.className = 'notification';
          notification.textContent = `Button pressed on device ${macAddress} at ${data.datetime || 'N/A'}, Location: (${data.press_latitude ? data.press_latitude.toFixed(6) : 'N/A'}, ${data.press_longitude ? data.press_longitude.toFixed(6) : 'N/A'})`;
          document.getElementById('notifications').prepend(notification);
          setTimeout(() => notification.remove(), 10000); // Remove after 10 seconds
        }
        console.log(`Button data for ${macAddress}:`, data);
      }, (error) => {
        console.error(`Button error for ${macAddress}:`, error);
        document.getElementById('error-message').textContent = `Error fetching button data for ${macAddress}: ${error.message}`;
      });

      // RFID Data
      const rfidRef = ref(db, `/devices/${macAddress}/rfid`);
      onValue(rfidRef, (snapshot) => {
        const data = snapshot.val() || {};
        document.getElementById(`rfid-uid-${macAddress}`).textContent = data.uid || 'none scanned';
        console.log(`RFID data for ${macAddress}:`, data);
      }, (error) => {
        console.error(`RFID error for ${macAddress}:`, error);
        document.getElementById('error-message').textContent = `Error fetching RFID data for ${macAddress}: ${error.message}`;
      });
    }

    // Send buzzer command and stop after 5 seconds
    window.sendBuzzerCommand = async (macAddress, command) => {
      try {
        await set(ref(db, `/devices/${macAddress}/buzzer`), command);
        console.log(`Sent ${command} command to ${macAddress}`);
        document.getElementById('error-message').textContent = `Sent ${command} command to ${macAddress}`;
        
        // Send stop command after 5 seconds
        setTimeout(async () => {
          try {
            await set(ref(db, `/devices/${macAddress}/buzzer`), 'stop');
            console.log(`Sent stop command to ${macAddress}`);
            document.getElementById('error-message').textContent = `Sent stop command to ${macAddress}`;
          } catch (error) {
            console.error('Error sending stop command:', error);
            document.getElementById('error-message').textContent = `Error sending stop command to ${macAddress}: ${error.message}`;
          }
        }, 5000);
      } catch (error) {
        console.error('Error sending command:', error);
        document.getElementById('error-message').textContent = `Error sending command to ${macAddress}: ${error.message}`;
      }
    };

    // Load devices when page loads
    window.addEventListener('load', () => {
      loadDevices();
      // Refresh devices every 30 seconds
      setInterval(loadDevices, 30000);
    });
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .error {
      color: red;
      text-align: center;
      margin-top: 1rem;
      font-weight: bold;
    }
    .section-title {
      color: #1f2937;
    }
    .data-field {
      margin-bottom: 0.5rem;
    }
    .data-label {
      font-weight: bold;
      color: #374151;
      margin-right: 0.5rem;
    }
    .data-value {
      color: #1f2937;
    }
    .notification {
      background-color: #fefcbf;
      color: #744210;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #f6e05e;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4 max-w-5xl">
    <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">ESP8266 Control Panel</h1>
    
    <!-- Error Message -->
    <div id="error-message" class="error"></div>

    <!-- Notifications -->
    <div id="notifications" class="mb-4"></div>

    <!-- Devices Display -->
    <div id="devices-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</body>
</html>